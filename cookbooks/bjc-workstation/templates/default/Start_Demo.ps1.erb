# Chef Demo Startup Script
<% home = Dir.home -%>
echo "Starting Google Chrome..."
& "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
echo "Starting PuTTY..."
& "C:\ProgramData\chocolatey\bin\PUTTY.EXE" -load delivered.automate-demo.com
echo "Starting Atom..."
& "<%= home -%>\AppData\Local\atom\bin\atom.cmd" <%= home -%>\cookbooks\site-config
echo "Starting cmder..."
& "C:\tools\cmder\Cmder.exe"
echo "Loading compliance profiles..."
ssh compliance "sudo chef-compliance-ctl restart; sleep 60; sudo /home/ubuntu/upload_apache_profile.sh; sudo /home/ubuntu/upload_ssl_profile.sh"
echo "Copying compliance OIDC_CLIENT_ID to chef CHEF_GATE_OIDC_CLIENT_ID"
scp ~/.ssh/id_rsa.pub compliance:/tmp/CHEF_GATE_COMPLIANCE_SECRET
ssh compliance 'sudo mv /tmp/CHEF_GATE_COMPLIANCE_SECRET /opt/chef-compliance/sv/core/env/CHEF_GATE_COMPLIANCE_SECRET && sudo chef-compliance-ctl restart core'
ssh compliance 'sudo cp /opt/chef-compliance/sv/core/env/OIDC_CLIENT_ID /tmp && sudo chmod +r /tmp/OIDC_CLIENT_ID'
scp -3 compliance:/tmp/OIDC_CLIENT_ID chef:/tmp/CHEF_GATE_OIDC_CLIENT_ID
ssh chef 'sudo mv /tmp/CHEF_GATE_OIDC_CLIENT_ID /opt/opscode/sv/chef_gate/env/CHEF_GATE_OIDC_CLIENT_ID && sudo /opt/opscode/embedded/bin/sv restart chef_gate'
echo "Preparing AURD nodes for demo..."
knife ssh *:* sudo chef-client -a name
echo "Importing infrastructure SSL certs..."
scp ecomacceptance:/home/ubuntu/ecomacceptance.crt /c/Users/Administrator/Downloads/
scp union:/home/ubuntu/union.crt /c/Users/Administrator/Downloads/
scp rehearsal:/home/ubuntu/rehearsal.crt /c/Users/Administrator/Downloads/
scp delivered:/home/ubuntu/delivered.crt /c/Users/Administrator/Downloads/
Import-Certificate -FilePath C:\Users\Administrator\Downloads\ecomacceptance.crt -CertStoreLocation Cert:/LocalMachine/Root
Import-Certificate -FilePath C:\Users\Administrator\Downloads\union.crt -CertStoreLocation Cert:/LocalMachine/Root
Import-Certificate -FilePath C:\Users\Administrator\Downloads\rehearsal.crt -CertStoreLocation Cert:/LocalMachine/Root
Import-Certificate -FilePath C:\Users\Administrator\Downloads\delivered.crt -CertStoreLocation Cert:/LocalMachine/Root
